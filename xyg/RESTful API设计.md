# Restful API设计

## API地址与版本号

常见两种方式：

- https://api.github.com/v3
- https://example.com/api/v3

如可能，建议第一种。

## Schema

建议前后端统一采用 JSON 作为数据交换的格式。请求和响应均设定 `Content-Type` 值为 `applicaiton/json`。如果 `POST` 请求体 `Body` 为空，就毋需设定 `Content-Type` 了。

## 以资源为中心的 URL 设计

资源是 RESTful 的核心，所有的操作都是针对特定资源进行的。而资源就是用 URL 表示的。

URL格式规范：

- 使用连字符 `-` 替代下划线 `_`
- 统一使用小写字母
- 不包含资源文件的扩展名
- 应仅仅包含资源，通过与 HTTP 方法结合使用，而不是包含动作或动词。例如，应使用 `(GET, POST) /students` 而不是 `get(addNew)Students`。
- 资源分为单个文档和集合，尽量使用复数来表示资源，单个资源通过添加 id 或者 name 等来表示。例如，`/students` 和 `/students/:id`
- 有层级关系的资源就表现为目录路径的层级

### 排序

为了请求特定排序的数据集，可以设定一个 `sort` 查询参数。例如，`GET /companies?sort=rank_asc`。

### 搜索

搜索通常使用查询字符串来实现，例如，`GET /students?search=ave`。

### 过滤

为了在请求时对数据集实现过滤，通常可以传递查询参数传递多个选项，例如，`GET /companies?category=banking&location=india`。

### 分页

对于分页的大量数据集，为了请求特定页的数据集，可以设定一个 `page` 查询参数。例如，`GET /companies?page=16`。

现在流行前后后端分离，为了使前端能够自行控制分页大小，便于请求指定范围的数据，可以设定 `offset` 和 `limit` 参数。例如，`GET /albums?offset=10&limit=5`，表示请求第10到第15条数据。

## 使用正确的 HTTP Method

| Method | 描述                                                            |
| ------ |:-------------------------------------------------------------:|
| HEAD   | 只获取某个资源的头部信息                                                  |
| GET    | 获取资源                                                          |
| POST   | 创建资源                                                          |
| PATCH  | 更新资源的部分属性（PATCH较新，规范复杂，支持的实现少，一般用 POST 代替）                    |
| PUT    | 替换资源，客户端需要提供新建资源的所有属性。如果新内容为空，需要设置 Content-Length 为 0，以区别错误信息 |
| DELETE | 删除资源                                                          |

Note：*更新和创建操作应该返回最新的资源，以通知API调用者资源的情况；删除资源一般不返回内容*

### 不符合 CRUD 的情况

在实际资源操作中，总会有一些不符合 CRUD 的情况，一般有以下几种处理方式：

#### 增加控制参数

添加动作相关的参数，通过修改参数来控制动作。

#### 把动作转换成资源

把动作转换为可执行 CRUD 操作的资源。

## 使用正确的 HTTP 状态码

- 2xx：请求正常处理并返回
- 3xx：重定向，请求的资源位置发生变化
- 4xx：客户端请求有误
- 5xx：服务器内部错误

常用的 HTTP 状态码说明如下：

### 2xx

- **200**，请求成功，一般相应中都会有 body。
- **201**，请求成功，一个或者多个资源资源被创建，最长用在 POST 创建资源时。
- **202**，请求已经接收并正在处理，但是处理还没有完成。一般用在异步处理的情况，响应 body 中应告诉客户端去哪儿查看任务状态。
- **203**，请求的代理服务器修改了源服务器返回的 200 中的内容，一般用不到。比如说，我们通过代理服务器向服务器 A 请求用户信息，服务器 A 正常响应，但代理服务器命中了缓存并返回了自己的缓存内容，这时候它返回 203 告诉我们这部分信息不一定是最新的，我们可以自行判断并处理。
- **204**，请求成功，没有需要返回的内容。例如，删除资源成功。
- **205**，类似 204，但是要求请求者重置视图，一般也用不到。比如说，我们请求删除某个用户，服务器返回 205 的话，我们就刷新现在的用户列表。
- **206**，请求成功，但根据请求头只返回了部分内容。例如，音视频文件的分片传输。

### 3xx

- **300**，请求成功，但结果有多种选择。例如，下载一部影片，服务器有avi、mp4多种格式，这是可以返回300，并在body里告知有哪些格式，然后客户端可以根据这些格式再次请求。
- **301**，请求成功，请求的资源已经永久性地移动到另外一个地方，后续所有的请求都应该直接访问新地址。服务端会把新地址写在 Location 头部字段，方便客户端使用。允许客户端把 POST 请求修改为 GET。
- **302**，请求成功，但是资源被临时转移了。和 301 不同的是，除非是 HEAD 请求，否则新地址的信息应当在 body 中返回，并且资源只是临时转移，以后不应当通过新地址来下载。
- **303**，请求成功，类似302，但要求使用 GET 方法来访问新地址获取资源。
- **304**，请求的资源和之前的版本一样，没有发生改变。用来缓存资源，和条件性请求（conditional request）一起出现
- **305**，请求的资源必须通过代理访问。
- **308**，类似301，但要求使用原有的请求方式来通过新地址获取资源

### 4xx

- **400**，客户端的请求有错误，例如，请求头不对等，所有不想明确区分的客户端请求出错都可以返回 400。
- **401**，请求的资源需要认证，客户端没有提供认证信息或者认证信息不正确）
- **403**，请求的资源不允许访问
- **404**，请求的资源内容不存在
- **405**，服务端接收到了请求，而且要访问的资源也存在，但是不支持对应的方法。服务端必须返回 Allow 头部，告诉客户端哪些方法是允许的
- **406**，请求的资源并不符合要求。例如，HTTP Header 中设定请求 JSON 格式的数据，但是服务器只有 XML 个数数据。
- **407**，类似401，但要求必须去同代理服务器进行认证。
- **408**，客户端请求超时。
- **408**，请求冲突。
- **410**，请求资源曾经存在，但现在不存在了。
- **411**，没有提供请求资源的长度。
- **412**，请求的资源不符合请求头中的 IF-* 某些条件。
- **413**，请求体过大。
- **414**，请求的URI太长了。
- **415**，服务端不支持客户端请求的资源格式，一般是因为客户端在 Content-Type 或者 Content-Encoding 中申明了希望的返回格式，但是服务端没有实现。比如，客户端希望收到 xml返回，但是服务端支持 Json
- **416**，分片请求资源时所请求的区间无效。
- **417**，预期错误。指服务器没法满足我们在请求头里的 Expect 相关的信息。
- **419**，客户端在规定时间内发送了太多次请求，在进行限流的时候会用到

### 5xx

- **500**，服务器内部错误，没法明确定义的服务器错误都可以返回这个。
- **501**，请求还没有被实现。
- **502**，网关错误。
- **503**，服务器暂时不可用
- **504**，类似502。
- **505**，请求的 HTTP 版本不支持。

## 限流 Rate Limit

为了减少服务器压力，防止 API 被滥用，甚至 DDOS 攻击，对客户端请求进行限流是很有必要的。

通常可以使用如下几个自定义 HTTP 头部：

- **X-RateLimit-Limit**：每小时允许发送的请求最大数
- **X-RateLimit-Remainingt**：当前时间窗口剩余的可用请求数
- **X-RateLimit-Rest**：时间窗口重置的时候，到这个时间点可用的请求数量就会变成 `X-RateLimit-Limit` 的值

## Hypermedia API

RESTful API的设计最好做到 Hypermedia，在返回结果中提供相关资源的链接

## 实例：Spotify API

以下仅选取代表性的 API 端点，对于体现相同设计原则的 API 端点仅仅选取一个作为示例。

### Albums

| HTTP方法 | API端点                |
| ------ |:-------------------- |
| GET    | `/albums`            |
| GET    | `/albums/:id`        |
| GET    | `/albums/:id/tracks` |

### Follow

| HTTP方法 | API端点                                                      |
| ------ |:---------------------------------------------------------- |
| GET    | `/users/:owner_id/playlist/:playlist_id/follwers/contains` |
| PUT    | `/me/following`                                            |
| PUT    | `/playlists/:playlist_id/followers`                        |
| GET    | `/me/following?type=artist`                                |
| DELETE | `/me/following`                                            |
| DELETE | `/playlists/:playlist_id/:followers`                       |
